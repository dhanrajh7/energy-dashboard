<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ Energy Monitoring Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            --primary-bg: #10151a; /* Very dark blue */
            --secondary-bg: #1d232c; /* Main content area, slightly lighter */
            --card-bg: #28303d; /* Card background, distinct from secondary */
            --text-color: #e0e6f1; /* Off-white text */
            --secondary-text: #a0acbd; /* Soft gray for labels */
            --primary-color: #A9B1BD; /* Light gray for highlights */
            --border-color: #3e4451;
            --highlight-color: #A9B1BD; /* Updated to gray */
            --header-bg: #1a2027; /* Distinct header background */
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
        }
        .container-fluid {
            max-width: 1500px;
        }
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
        }
        .header-logo {
            height: 50px; /* Maximized logo height */
            margin-right: 15px; /* Add some spacing */
        }
        .header-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: center;
            flex-grow: 1;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.75rem 2rem rgba(0, 0, 0, 0.15), 
                        inset 0 4px 15px rgba(169, 177, 189, 0.4); /* Glow effect with gray */
            border-color: var(--primary-color);
        }
        .status-light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid var(--card-bg);
            box-shadow: 0 0 5px rgba(0,0,0,0.4);
        }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }
        .tab-content {
            background-color: var(--secondary-bg);
            padding: 2rem;
            border-radius: 0 0 1rem 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
        }
        .nav-tabs {
            border-bottom: none;
        }
        .nav-tabs .nav-link {
            border: none;
            color: var(--secondary-text);
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.2s;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--secondary-bg);
            border-bottom: 3px solid var(--primary-color);
        }
        .value-label {
            font-weight: 400;
            color: var(--secondary-text);
            font-size: 0.85rem;
        }
        .value-data {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .card-body {
            font-size: 0.85rem;
        }
        .card-title {
            color: var(--primary-color);
            font-weight: 600;
        }
        .card-subtitle {
            color: var(--secondary-text);
            font-size: 0.8rem;
        }
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: var(--secondary-bg);
        }
        .table-striped > tbody > tr:nth-of-type(even) {
            background-color: var(--primary-bg);
        }
        .table-bordered th, .table-bordered td {
            border-color: var(--border-color);
        }
        .meter-data-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.35rem 0.75rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
            color: var(--primary-color);
        }
        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-footer small {
            color: var(--secondary-text) !important;
        }
        .form-label {
            color: var(--text-color) !important; /* Force white color for form labels */
        }
        .tab-content h2, .tab-content h3, .list-group-item {
            color: var(--text-color) !important;
        }
        .list-group-item small {
            color: var(--secondary-text) !important;
        }
        .bg-transparent {
            background-color: transparent !important;
        }
        .alert-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="header-top">
            <img src="/images/logo.png" alt="Company Logo" class="header-logo">
            <h1 class="header-title">⚡ Energy Monitoring Dashboard</h1>
            <div style="width: 50px;"></div>
        </div>

        <ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="meters-tab" data-bs-toggle="tab" data-bs-target="#meters" type="button" role="tab"><i class="bi bi-speedometer2 me-2"></i>Meter View</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab"><i class="bi bi-graph-up-arrow me-2"></i>Charts</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab"><i class="bi bi-table me-2"></i>Event Data</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                    <i class="bi bi-bell-fill me-2"></i>Alerts 
                    <span id="alertCountBadge" class="badge rounded-pill bg-danger d-none">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="alerts-setup-tab" data-bs-toggle="tab" data-bs-target="#alerts-setup" type="button" role="tab"><i class="bi bi-gear-fill me-2"></i>Alerts Setup</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="meters" role="tabpanel" aria-labelledby="meters-tab">
                <div class="row row-cols-1 row-cols-md-4 g-4 mt-3" id="meter-cards-container">
                    </div>
            </div>

            <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
                <div class="mt-4">
                    <h2 class="mb-3">Latest Total KWH per Meter</h2>
                    <div class="card p-3">
                        <canvas id="kwhBarChart"></canvas>
                    </div>
                </div>
                
                <hr class="my-5">

                <h2 class="mb-3">Historical Data Charts</h2>
                <div class="card p-4 mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="chartMeterSelect" class="form-label">Meter</label>
                            <select id="chartMeterSelect" class="form-select"></select>
                        </div>
                        <div class="col-md-3">
                            <label for="chartStartDate" class="form-label">Start Date</label>
                            <input type="datetime-local" id="chartStartDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="chartEndDate" class="form-label">End Date</label>
                            <input type="datetime-local" id="chartEndDate" class="form-control">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="updateChartsBtn">Update Charts</button>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5 class="card-title">Power Factor vs. Time</h5>
                            <canvas id="powerFactorLineChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5 class="card-title">Current vs. Time</h5>
                            <canvas id="currentLineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="events" role="tabpanel" aria-labelledby="events-tab">
                <div class="mt-4">
                    <h2 class="mb-3">Event Data</h2>
                    <div class="card p-4 mb-4">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="eventMeterSelect" class="form-label">Meter</label>
                                <select id="eventMeterSelect" class="form-select">
                                    <option value="">All Meters</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="eventStartDate" class="form-label">Start Date</label>
                                <input type="datetime-local" id="eventStartDate" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label for="eventEndDate" class="form-label">End Date</label>
                                <input type="datetime-local" id="eventEndDate" class="form-control">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="filterEventsBtn">Filter Events</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>EventID</th>
                                    <th>MeterID</th>
                                    <th>Timestamp</th>
                                    <th>AvgCurrent</th>
                                    <th>AvgVoltage</th>
                                    <th>AvgPowerFactor</th>
                                    <th>Total_KW</th>
                                    <th>Total_KWH</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="alerts" role="tabpanel" aria-labelledby="alerts-tab">
                <div class="mt-4">
                    <h2 class="mb-3">Triggered Alerts</h2>
                    <ul id="triggeredAlertsList" class="list-group">
                        </ul>
                </div>
            </div>

            <div class="tab-pane fade" id="alerts-setup" role="tabpanel" aria-labelledby="alerts-setup-tab">
                <div class="mt-4">
                    <h3 class="mb-3">Active Alert Rules</h3>
                    <ul id="activeAlertsList" class="list-group mb-5">
                        </ul>
                    
                    <hr class="my-5">

                    <h3 class="mt-5">Alert Setup</h3>
                    <div class="card p-4 mb-4">
                        <form id="alertForm" class="row g-3">
                            <input type="hidden" id="alertIndex" value="-1">
                            <div class="col-md-3">
                                <label for="alertMeterSelect" class="form-label">Meter</label>
                                <select id="alertMeterSelect" class="form-select" required></select>
                            </div>
                            <div class="col-md-3">
                                <label for="alertParamSelect" class="form-label">Parameter</label>
                                <select id="alertParamSelect" class="form-select" required>
                                    <option value="" disabled selected>Select Parameter</option>
                                    <option value="AvgCurrent">AvgCurrent</option>
                                    <option value="AvgVoltage">AvgVoltage</option>
                                    <option value="Total_KW">Total_KW</option>
                                    <option value="Total_KWH">Total_KWH</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="alertThreshold" class="form-label">Threshold Value</label>
                                <input type="number" step="0.01" id="alertThreshold" class="form-control" placeholder="e.g., 25.5" required>
                            </div>
                            <div class="col-md-3">
                                <label for="alertMessage" class="form-label">Alert Message</label>
                                <input type="text" id="alertMessage" class="form-control" placeholder="e.g., Current is too high!" required>
                            </div>
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary mt-3"><i class="bi bi-save me-2"></i>Save Alert</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="powerFactorModal" tabindex="-1" aria-labelledby="powerFactorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="powerFactorModalLabel">Power Factor vs. Time</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <canvas id="powerFactorModalChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="currentModal" tabindex="-1" aria-labelledby="currentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="currentModalLabel">Current vs. Time</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <canvas id="currentModalChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/dashboard.js"></script>
</body>
</html>